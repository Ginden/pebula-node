(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{125:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return d}));var o=n(1),a=n(6),i=(n(0),n(148)),c=n(153),r={id:"async-model-compilation",title:"Async Model Compilation",sidebar_label:"7. Async Model Compilation"},l={id:"advanced/async-model-compilation",title:"Async Model Compilation",description:"**GooseTyped** works in 2 modes:",source:"@site/docs/advanced/async-model-compilation.md",permalink:"/pebula-node/goosetyped/docs/advanced/async-model-compilation",editUrl:"https://github.com/shlomiassaf/pebula-node/tree/master/packages/goosetyped/website/docs/advanced/async-model-compilation.md",sidebar_label:"7. Async Model Compilation",sidebar:"someSidebar",previous:{title:"Plugins",permalink:"/pebula-node/goosetyped/docs/advanced/plugins"},next:{title:"Utilities",permalink:"/pebula-node/goosetyped/docs/utilities/utilities"}},s=[{value:"Sync VS Async",id:"sync-vs-async",children:[]},{value:"Async Compilation",id:"async-compilation",children:[]}],p={rightToc:s};function d(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(o.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"GooseTyped")," works in 2 modes:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Immediate Model Compilation"),Object(i.b)("li",{parentName:"ul"},"Async Model Compilation")),Object(i.b)("p",null,"To simplify the configuration the mode in which each model is compiled is determined by connection it is attached to."),Object(i.b)("p",null,"When the default connection is used the compilation is immediate.",Object(i.b)("br",{parentName:"p"}),"\n","When a specific connection is used the compilation is async."),Object(i.b)("h2",{id:"sync-vs-async"},"Sync VS Async"),Object(i.b)("p",null,"What does it means anyway?"),Object(i.b)("p",null,"Since decorators are not (yet) part of the JS spec, TypeScript converts them into simple functions that\ninvoke along with the creation of the class."),Object(i.b)("p",null,"First, all of the member level decorators fire (i.e those on properties and methods) and at the end the class decorators\nfire (e.g. ",Object(i.b)("inlineCode",{parentName:"p"},"@GtDocument"),")."),Object(i.b)("p",null,"Once ",Object(i.b)("inlineCode",{parentName:"p"},"@GtDocument")," fires it will check if there is a ",Object(i.b)("inlineCode",{parentName:"p"},"connectionId")," defined, if not it will compile the model before the module itself finish to initialize and export the model class."),Object(i.b)("p",null,"This is a synchronous run which fits the default connection as it is also set immediately in mongoose."),Object(i.b)("h2",{id:"async-compilation"},"Async Compilation"),Object(i.b)("p",null,"The same process occurs in an async compilation except that now ",Object(i.b)("inlineCode",{parentName:"p"},"@GtDocument")," fires and detects that ",Object(i.b)("inlineCode",{parentName:"p"},"connectionId")," is defined."),Object(i.b)("pre",null,Object(i.b)("code",Object(o.a)({parentName:"pre"},{className:"language-ts"}),"import mongoose from 'mongoose';\nimport { GtDocument, GtModel, GtColumn, addConnection } from '@pebula/goosetyped';\n\n@GtDocument({\n  connectionId: 'myConnection',\n})\nexport class Customer extends GtModel() {\n  @GtColumn()\n  name: string;\n\n  @GtColumn()\n  age: number;\n}\n")),Object(i.b)("p",null,"At this point it will wait to see if the user has added this connection."),Object(i.b)("p",null,'When no connection is found, nothing is done and the model will "wait" for the connection to be added.',Object(i.b)("br",{parentName:"p"}),"\n","If the connection exists, the compilation will run at one of two options (user defined):"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("strong",{parentName:"li"},"immediate")," ","[default]"," - Compile the model once a reference to the connection is obtained."),Object(i.b)("li",{parentName:"ol"},Object(i.b)("strong",{parentName:"li"},"connected")," - Compile the model once the connection state changes to ",Object(i.b)("inlineCode",{parentName:"li"},"connected"),".")),Object(i.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(i.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(o.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(o.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(i.b)("path",Object(o.a)({parentName:"svg"},{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})))),"warning")),Object(i.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"Do not use the model before it is compiled using a connection."))),Object(i.b)("p",null,"Now, let's register the connection so our model can compile:"),Object(i.b)("pre",null,Object(i.b)("code",Object(o.a)({parentName:"pre"},{className:"language-typescript"}),"const connection = mongoose.createConnection('localhost',{ /* ...*/ });\nconst ready = addConnection('myConnection', () => connection, { compileAt: 'immediate' });\nawait ready;\n")),Object(i.b)("p",null,"Once ",Object(i.b)("inlineCode",{parentName:"p"},"ready")," ",Object(i.b)("strong",{parentName:"p"},"resolves")," we have a guarantee that all models are compiled and bound to the connection."),Object(i.b)("p",null,"The factory function (",Object(i.b)("inlineCode",{parentName:"p"},"() => connection"),") return the connection or it can return a ",Object(i.b)("inlineCode",{parentName:"p"},"Promise")," for the connection.",Object(i.b)("br",{parentName:"p"}),"\n","Once the factory function resolves (including promise, if returned) then the models compile and the process ends."),Object(i.b)("p",null,"If we set ",Object(i.b)("inlineCode",{parentName:"p"},"compileAt")," to ",Object(i.b)("strong",{parentName:"p"},"connected")," the model will wait for the connection state to change to ",Object(i.b)("strong",{parentName:"p"},"connected")," and only then\nall models will compile and the process will end."),Object(i.b)("div",{className:"admonition admonition-caution alert alert--warning"},Object(i.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(o.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(o.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"}),Object(i.b)("path",Object(o.a)({parentName:"svg"},{fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"})))),"caution")),Object(i.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"It is best to compile as early as possible, think before you use ",Object(i.b)("strong",{parentName:"p"},"connected")))),Object(i.b)("p",null,"Watch out from the Promise Like connection object returned from ",Object(i.b)("inlineCode",{parentName:"p"},"mongoose.createConnection"),", when returned from the factory\nfunction like done above it will actually treat it as a promise and will resolve the factory once the connection is connected."),Object(i.b)("p",null,"Fix:"),Object(i.b)("pre",null,Object(i.b)("code",Object(o.a)({parentName:"pre"},{className:"language-typescript"}),"const connection = await mongoose.createConnection('localhost',{ /* ...*/ });\nconst ready = addConnection('myConnection', () => connection, { compileAt: 'immediate' });\nawait ready;\n")),Object(i.b)(c.a,{type:"interface",symbol:"GtConnectOptions",mdxType:"ApiDocsLink"}))}d.isMDXComponent=!0},148:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var o=n(0),a=n.n(o);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),p=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r({},t,{},e)),n},d=function(e){var t=p(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},b=Object(o.forwardRef)((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,c=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),d=p(n),b=o,u=d["".concat(c,".").concat(b)]||d[b]||m[b]||i;return n?a.a.createElement(u,r({ref:t},s,{components:n})):a.a.createElement(u,r({ref:t},s))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,c=new Array(i);c[0]=b;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:o,c[1]=r;for(var s=2;s<i;s++)c[s]=n[s];return a.a.createElement.apply(null,c)}return a.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"},149:function(e,t,n){"use strict";var o=n(0),a=n(35);t.a=function(){return Object(o.useContext)(a.a)}},153:function(e,t,n){"use strict";var o=n(0),a=n.n(o),i=(n(95),n(149));function c(e){switch(e){case"interface":return"interfaces";case"globals":return"globals"}throw new Error("Unknown link segment type "+e)}t.a=function(e){const t=Object(i.a)(),{type:n,symbol:o,hash:r,display:l}=e,s=o?`${t.siteConfig.customFields.apiDocsUrl}/${c(n)}/${o.toLowerCase()}.html${r?"#"+r.toLowerCase():""}`:`${t.siteConfig.customFields.apiDocsUrl}/${c(n)}.html${r?"#"+r.toLowerCase():""}`;return a.a.createElement("a",{href:s,target:"_blank"},e.children||l||o)}}}]);